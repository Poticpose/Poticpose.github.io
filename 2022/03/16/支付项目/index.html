
<!DOCTYPE html>
<html lang="zh-CN" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>微信支付项目（步骤化） - 诗文的小书屋</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="blog,"> 
    <meta name="description" content="创建项目主要依赖引入12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849,"> 
    <meta name="author" content="Poet"> 
    <link rel="alternative" href="atom.xml" title="诗文的小书屋" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

    
<link rel="stylesheet" href="/css/diaspora.css">

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-8691406134231910",
              enable_page_level_ads: true
         });
    </script>
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="loading">
    <span id="config-title" style="display:none">诗文的小书屋</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="https://poticpose.github.io"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">微信支付项目（步骤化）</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">微信支付项目（步骤化）</h1>
        <div class="stuff">
            <span>三月 16, 2022</span>
            
  <ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/Java/" rel="tag">Java</a></li></ul>


        </div>
        <div class="content markdown">
            <h1 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h1><h2 id="主要依赖引入"><a href="#主要依赖引入" class="headerlink" title="主要依赖引入"></a>主要依赖引入</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- json处理器 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 生成自定义配置的元数据信息 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>包含：</p>
<ul>
<li>Mysql</li>
<li>Mybatis-plus</li>
<li>swagger：自动生成接口文档和相关测试页面</li>
<li>springboot-web</li>
</ul>
<hr>
<h2 id="自定义配置文件"><a href="#自定义配置文件" class="headerlink" title="自定义配置文件"></a>自定义配置文件</h2><ul>
<li>Swagger2Config</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2     <span class="comment">//Swagger2文件的注解</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Swagger2Config</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">docket</span><span class="params">()</span></span>&#123; <span class="comment">//Swagger2中的文档对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2);  <span class="comment">//docket类型由构造函数中的参数进行定义</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 应用名称</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">payment-demo</span></span><br><span class="line"><span class="comment"># THYMELEAF (ThymeleafAutoConfiguration)</span></span><br><span class="line"><span class="comment"># 开启模板缓存（默认值： true ）</span></span><br><span class="line"><span class="meta">spring.thymeleaf.cache</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 检查模板是否存在，然后再呈现</span></span><br><span class="line"><span class="meta">spring.thymeleaf.check-template</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 检查模板位置是否正确（默认值 :true ）</span></span><br><span class="line"><span class="meta">spring.thymeleaf.check-template-location</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#Content-Type 的值（默认值： text/html ）</span></span><br><span class="line"><span class="meta">spring.thymeleaf.content-type</span>=<span class="string">text/html</span></span><br><span class="line"><span class="comment"># 开启 MVC Thymeleaf 视图解析（默认值： true ）</span></span><br><span class="line"><span class="meta">spring.thymeleaf.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 模板编码</span></span><br><span class="line"><span class="meta">spring.thymeleaf.encoding</span>=<span class="string">UTF-8</span></span><br><span class="line"><span class="comment"># 要被排除在解析之外的视图名称列表，⽤逗号分隔</span></span><br><span class="line"><span class="meta">spring.thymeleaf.excluded-view-names</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># 要运⽤于模板之上的模板模式。另⻅ StandardTemplate-ModeHandlers( 默认值： HTML5)</span></span><br><span class="line"><span class="meta">spring.thymeleaf.mode</span>=<span class="string">HTML5</span></span><br><span class="line"><span class="comment"># 在构建 URL 时添加到视图名称前的前缀（默认值： classpath:/templates/ ）</span></span><br><span class="line"><span class="meta">spring.thymeleaf.prefix</span>=<span class="string">classpath:/templates/</span></span><br><span class="line"><span class="comment"># 在构建 URL 时添加到视图名称后的后缀（默认值： .html ）</span></span><br><span class="line"><span class="meta">spring.thymeleaf.suffix</span>=<span class="string">.html</span></span><br><span class="line"><span class="comment"># 数据库驱动：</span></span><br><span class="line"><span class="meta">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="comment"># 数据源名称</span></span><br><span class="line"><span class="meta">spring.datasource.name</span>=<span class="string">defaultDataSource</span></span><br><span class="line"><span class="comment"># 数据库连接地址</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/payment_demo?serverTimezone=GMT%2B8&amp;characterEncoding=utf-8</span></span><br><span class="line"><span class="comment"># 数据库用户名&amp;密码：</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">102654</span></span><br><span class="line"><span class="comment"># 应用服务 WEB 访问端口</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">8090</span></span><br><span class="line"><span class="comment">#设置时间格式</span></span><br><span class="line"><span class="meta">spring.jackson.date-format</span>=<span class="string">yyyy-MM-dd HH:mm:ss</span></span><br><span class="line"><span class="meta">spring.jackson.time-zone</span>=<span class="string">GMT+8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看SQL日志</span></span><br><span class="line"><span class="meta">mybatis-plus.configuration.log-impl</span>=<span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line"><span class="comment">#MybatisPlus 获取xml数据操作</span></span><br><span class="line"><span class="meta">mybatis-plus.mapper-locations</span>=<span class="string">classpath:com/poem/paymentdemo/mapper/xml/*.xml</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ProductController-商品接口"><a href="#ProductController-商品接口" class="headerlink" title="ProductController 商品接口"></a>ProductController 商品接口</h2><p>先写出基础测试功能</p>
<p>@RestController：使该类以 JSON 形式返回数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api/product"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"test"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动项目，在浏览器输入 localhost:8090/swagger-ui.html 就可以选择需要查看的测试接口信息。</p>
<img src='/img/springboot/4/1.png'>

<hr>
<h1 id="R-类对前端进行数据反馈"><a href="#R-类对前端进行数据反馈" class="headerlink" title="R 类对前端进行数据反馈"></a>R 类对前端进行数据反馈</h1><p>简化版：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span>   <span class="comment">//lombok注解，自动生成get、set等操作</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">R</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer code;   <span class="comment">//响应码</span></span><br><span class="line">    <span class="keyword">private</span> String message; <span class="comment">//响应消息</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Object&gt; data = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> R <span class="title">ok</span><span class="params">()</span></span>&#123;   <span class="comment">//成功获取数据的提示方法</span></span><br><span class="line">        R r = <span class="keyword">new</span> R();</span><br><span class="line">        r.setCode(<span class="number">0</span>);   <span class="comment">//响应码为0则成功</span></span><br><span class="line">        r.setMessage(<span class="string">"成功"</span>);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> R <span class="title">error</span><span class="params">()</span></span>&#123;   <span class="comment">//错误获取数据的提示方法</span></span><br><span class="line">        R r = <span class="keyword">new</span> R();</span><br><span class="line">        r.setCode(-<span class="number">1</span>);   <span class="comment">//响应码为-1则失败</span></span><br><span class="line">        r.setMessage(<span class="string">"失败"</span>);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">data</span><span class="params">(String key,Object value)</span></span>&#123;    <span class="comment">//对前端进行数据传输</span></span><br><span class="line">        <span class="keyword">this</span>.data.put(key,value);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时可以让 ProductController 接收 R 的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api</span>(<span class="string">"商品管理"</span>)    <span class="comment">//设置测试页面测试接口名称</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api/product"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(<span class="string">"测试接口"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.ok().data(<span class="string">"message"</span>,<span class="string">"hello"</span>).data(<span class="string">"now"</span>, <span class="keyword">new</span> Date());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次前往接口文档查看</p>
<img src='/img/springboot/4/2.png'>

<hr>
<h2 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h2><p>创建 Mysql 数据库：payment_demo 到 IDEA 进行连接</p>
<img src='/img/springboot/4/3.png'>

<p>成功连接</p>
<p>在控制台录入 SQL 语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> <span class="string">`payment_demo`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Table structure for table `t_order_info` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_order_info`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'订单id'</span>,</span><br><span class="line">  <span class="string">`title`</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单标题'</span>,</span><br><span class="line">  <span class="string">`order_no`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商户订单编号'</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户id'</span>,</span><br><span class="line">  <span class="string">`product_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付产品id'</span>,</span><br><span class="line">  <span class="string">`total_fee`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单金额(分)'</span>,</span><br><span class="line">  <span class="string">`code_url`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单二维码连接'</span>,</span><br><span class="line">  <span class="string">`order_status`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单状态'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`update_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*Table structure for table `t_payment_info` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_payment_info`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'支付记录id'</span>,</span><br><span class="line">  <span class="string">`order_no`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商户订单编号'</span>,</span><br><span class="line">  <span class="string">`transaction_id`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付系统交易编号'</span>,</span><br><span class="line">  <span class="string">`payment_type`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付类型'</span>,</span><br><span class="line">  <span class="string">`trade_type`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'交易类型'</span>,</span><br><span class="line">  <span class="string">`trade_state`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'交易状态'</span>,</span><br><span class="line">  <span class="string">`payer_total`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付金额(分)'</span>,</span><br><span class="line">  <span class="string">`content`</span> <span class="built_in">text</span> <span class="keyword">COMMENT</span> <span class="string">'通知参数'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`update_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*Table structure for table `t_product` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_product`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'商品id'</span>,</span><br><span class="line">  <span class="string">`title`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品名称'</span>,</span><br><span class="line">  <span class="string">`price`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'价格（分）'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`update_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Data for the table `t_product` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> <span class="string">`t_product`</span>(<span class="string">`title`</span>,<span class="string">`price`</span>) <span class="keyword">values</span> (<span class="string">'Java课程'</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> <span class="string">`t_product`</span>(<span class="string">`title`</span>,<span class="string">`price`</span>) <span class="keyword">values</span> (<span class="string">'大数据课程'</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> <span class="string">`t_product`</span>(<span class="string">`title`</span>,<span class="string">`price`</span>) <span class="keyword">values</span> (<span class="string">'前端课程'</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> <span class="string">`t_product`</span>(<span class="string">`title`</span>,<span class="string">`price`</span>) <span class="keyword">values</span> (<span class="string">'UI课程'</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Table structure for table `t_refund_info` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_refund_info`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'退款单id'</span>,</span><br><span class="line">  <span class="string">`order_no`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商户订单编号'</span>,</span><br><span class="line">  <span class="string">`refund_no`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商户退款单编号'</span>,</span><br><span class="line">  <span class="string">`refund_id`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付系统退款单号'</span>,</span><br><span class="line">  <span class="string">`total_fee`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'原订单金额(分)'</span>,</span><br><span class="line">  <span class="string">`refund`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'退款金额(分)'</span>,</span><br><span class="line">  <span class="string">`reason`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'退款原因'</span>,</span><br><span class="line">  <span class="string">`refund_status`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'退款状态'</span>,</span><br><span class="line">  <span class="string">`content_return`</span> <span class="built_in">text</span> <span class="keyword">COMMENT</span> <span class="string">'申请退款返回参数'</span>,</span><br><span class="line">  <span class="string">`content_notify`</span> <span class="built_in">text</span> <span class="keyword">COMMENT</span> <span class="string">'退款结果通知参数'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`update_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="创建对应数据库表类"><a href="#创建对应数据库表类" class="headerlink" title="创建对应数据库表类"></a>创建对应数据库表类</h2><ul>
<li>BaseEntity（所有对应表类的父类，存放所有表共有数据）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义主键策略：跟随数据库的主键自增</span></span><br><span class="line">    <span class="meta">@TableId</span>(value = <span class="string">"id"</span>, type = IdType.AUTO)</span><br><span class="line">    <span class="keyword">private</span> String id; <span class="comment">//主键</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date createTime;<span class="comment">//创建时间</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;<span class="comment">//更新时间</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>OrderInfo（订单信息表）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(<span class="string">"t_order_info"</span>)  <span class="comment">//表名</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderInfo</span>  <span class="keyword">extends</span> <span class="title">BaseEntity</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String title;<span class="comment">//订单标题</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String orderNo;<span class="comment">//商户订单编号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId;<span class="comment">//用户id</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long productId;<span class="comment">//支付产品id</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer totalFee;<span class="comment">//订单金额(分)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String codeUrl;<span class="comment">//订单二维码连接</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String orderStatus;<span class="comment">//订单状态</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>PaymentInfo（支付信息表）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(<span class="string">"t_payment_info"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String orderNo;<span class="comment">//商品订单编号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String transactionId;<span class="comment">//支付系统交易编号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String paymentType;<span class="comment">//支付类型</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String tradeType;<span class="comment">//交易类型</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String tradeState;<span class="comment">//交易状态</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer payerTotal;<span class="comment">//支付金额(分)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String content;<span class="comment">//通知参数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Product（商品信息表）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(<span class="string">"t_product"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String title; <span class="comment">//商品名称</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer price; <span class="comment">//价格（分）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>RefundInfo（退款信息表）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(<span class="string">"t_refund_info"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RefundInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String orderNo;<span class="comment">//商品订单编号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String refundNo;<span class="comment">//退款单编号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String refundId;<span class="comment">//支付系统退款单号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer totalFee;<span class="comment">//原订单金额(分)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer refund;<span class="comment">//退款金额(分)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String reason;<span class="comment">//退款原因</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String refundStatus;<span class="comment">//退款单状态</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String contentReturn;<span class="comment">//申请退款返回参数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String contentNotify;<span class="comment">//退款结果通知参数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意 @TableName 注解会自动将驼峰命名法字段与数据库下划线字段提供映射匹配，如：</p>
<p>（数据库表）total_fee &lt;—-&gt; （Java对应类字段）totalFee</p>
<hr>
<h2 id="持久层接口"><a href="#持久层接口" class="headerlink" title="持久层接口"></a>持久层接口</h2><ul>
<li>OrderInfoMapper</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderInfoMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">OrderInfo</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>PaymentInfoMapper</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentInfoMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">PaymentInfo</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ProductMapper</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">Product</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>RefundInfoMapper</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RefundInfoMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">RefundInfo</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BaseMapper 是 Mybatis-plus 提供的通用 Mapper，他自动提供了增删改查的功能，调用时会自动映射</p>
<hr>
<h2 id="Service接口"><a href="#Service接口" class="headerlink" title="Service接口"></a>Service接口</h2><ul>
<li>OrderInfoService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderInfoService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">OrderInfo</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>PaymentInfoService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentInfoService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ProductService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">Product</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>RefundInfoService</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RefundInfoService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">RefundInfo</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IService 接口是 Mybatis-plus 提供的预定义接口，其中包含的抽象方法有增删改查、分页、批量处理等</p>
<hr>
<p>Service 实现类</p>
<ul>
<li>OrderInfoServiceImpl</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderInfoServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">OrderInfoMapper</span>, <span class="title">OrderInfo</span>&gt; <span class="keyword">implements</span> <span class="title">OrderInfoService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>PaymentInfoServiceImpl</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentInfoServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">PaymentInfoMapper</span>, <span class="title">PaymentInfo</span>&gt; <span class="keyword">implements</span> <span class="title">PaymentInfoService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ProductServiceImpl</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">ProductMapper</span>, <span class="title">Product</span>&gt; <span class="keyword">implements</span> <span class="title">ProductService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>RefundInfoServiceImpl</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RefundInfoServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">RefundInfoMapper</span>, <span class="title">RefundInfo</span>&gt; <span class="keyword">implements</span> <span class="title">RefundInfoService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 ServiceImpl 就是 IService 的实现类，各个 Service 继承该类，则继承了 IService 的所有抽象方法</p>
<hr>
<h2 id="创建-MyBatisPlusConfig-类"><a href="#创建-MyBatisPlusConfig-类" class="headerlink" title="创建 MyBatisPlusConfig 类"></a>创建 MyBatisPlusConfig 类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"package com.poem.paymentdemo.mapper;"</span>)</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span>    <span class="comment">//启用事务管理</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisPlusConfig</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续修改 ProductController 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CrossOrigin</span>    <span class="comment">//开启跨域</span></span><br><span class="line"><span class="meta">@Api</span>(<span class="string">"商品管理"</span>)    <span class="comment">//设置测试页面测试接口名称</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api/product"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ProductService productService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(<span class="string">"测试接口"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.ok().data(<span class="string">"message"</span>,<span class="string">"hello"</span>).data(<span class="string">"now"</span>, <span class="keyword">new</span> Date());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/list"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">list</span><span class="params">()</span></span>&#123;    <span class="comment">//商品列表查询</span></span><br><span class="line">        List&lt;Product&gt; list = productService.list();</span><br><span class="line">        <span class="keyword">return</span> R.ok().data(<span class="string">"productList"</span>, list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入接口文档页面</p>
<img src='/img/springboot/4/4.png'>

<p>成功获取后台数据</p>
<hr>
<h1 id="前端初步配置"><a href="#前端初步配置" class="headerlink" title="前端初步配置"></a>前端初步配置</h1><ul>
<li>utils/request.js（请求后端数据）</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Message &#125; <span class="keyword">from</span> <span class="string">'element-ui'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建axios实例</span></span><br><span class="line"><span class="keyword">const</span> service = axios.create(&#123;</span><br><span class="line">  baseURL: <span class="string">'http://localhost:8090'</span>, <span class="comment">// api 的 base_url</span></span><br><span class="line">  timeout: <span class="number">10000</span> <span class="comment">// 请求超时时间</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// request拦截器</span></span><br><span class="line">service.interceptors.request.use(</span><br><span class="line">  config =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> config</span><br><span class="line">  &#125;,</span><br><span class="line">  error =&gt; &#123;</span><br><span class="line">    <span class="comment">// Do something with request error</span></span><br><span class="line">    <span class="built_in">Promise</span>.reject(error)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// response 拦截器</span></span><br><span class="line">service.interceptors.response.use(</span><br><span class="line">  response =&gt; &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">const</span> res = response.data</span><br><span class="line">    <span class="keyword">if</span> (res.code &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      Message(&#123;</span><br><span class="line">        message: res.message,</span><br><span class="line">        type: <span class="string">'error'</span>,</span><br><span class="line">        duration: <span class="number">5</span> * <span class="number">1000</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="string">'error'</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> response.data</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  error =&gt; &#123;</span><br><span class="line">    Message(&#123;</span><br><span class="line">      message: error.message,</span><br><span class="line">      type: <span class="string">'error'</span>,</span><br><span class="line">      duration: <span class="number">5</span> * <span class="number">1000</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> service</span><br></pre></td></tr></table></figure>

<ul>
<li>main.js</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入Vue</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="comment">// 引入ElementUI</span></span><br><span class="line"><span class="keyword">import</span> ElementUI <span class="keyword">from</span> <span class="string">'element-ui'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'element-ui/lib/theme-chalk/index.css'</span></span><br><span class="line"><span class="comment">// 引入App</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line"><span class="comment">// 引入路由器</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./router'</span></span><br><span class="line"><span class="comment">// 二维码生成器</span></span><br><span class="line"><span class="keyword">import</span> VueQriously <span class="keyword">from</span> <span class="string">'vue-qriously'</span></span><br><span class="line">Vue.use(VueQriously)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭Vue生产提示</span></span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Vue.use(ElementUI)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(App), <span class="comment">//将App组件放入容器中</span></span><br><span class="line">  router: router</span><br><span class="line">&#125;).$mount(<span class="string">'#app'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>router/index.js（路由配置）</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建应用程序的路由器</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> VueRouter <span class="keyword">from</span> <span class="string">'vue-router'</span></span><br><span class="line"><span class="comment">// 此时就可以在Vue实例中配置路由器了</span></span><br><span class="line">Vue.use(VueRouter)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入组件</span></span><br><span class="line"><span class="keyword">import</span> Index <span class="keyword">from</span> <span class="string">'../views/index'</span></span><br><span class="line"><span class="keyword">import</span> Orders <span class="keyword">from</span> <span class="string">'../views/Orders'</span></span><br><span class="line"><span class="keyword">import</span> Download <span class="keyword">from</span> <span class="string">'../views/Download'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建并暴露一个路由器</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> VueRouter(&#123;</span><br><span class="line">    routes:[</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">'/'</span>,</span><br><span class="line">            component: Index</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">'/orders'</span>,</span><br><span class="line">            component: Orders</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">'/download'</span>,</span><br><span class="line">            component: Download</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>App.vue</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 公共头 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">AppHeader</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- /公共头 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-view</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 公共底 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">AppFooter</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- /公共底 --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> AppHeader <span class="keyword">from</span> <span class="string">'./components/AppHeader'</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> AppFooter <span class="keyword">from</span> <span class="string">'./components/AppFooter'</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> <span class="string">'./assets/css/reset.css'</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> <span class="string">'./assets/css/theme.css'</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> <span class="string">'./assets/css/global.css'</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">  name: <span class="string">'App'</span>,</span></span><br><span class="line">  components: &#123;</span><br><span class="line">    AppHeader, AppFooter</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>暂且提供这些重要需求</p>
<p>搭配刚才的后端代码进行效果展示：</p>
<img src='/img/springboot/4/5.png'>

<hr>
<h1 id="基础支付-API-v3"><a href="#基础支付-API-v3" class="headerlink" title="基础支付 API v3"></a>基础支付 API v3</h1><h2 id="引入支付参数"><a href="#引入支付参数" class="headerlink" title="引入支付参数"></a>引入支付参数</h2><p>优先获取微信支付所提供的数字证书</p>
<ul>
<li>添加配置文件 wxpay.properties，并在 IDEA 中设置为 Springboot 自定义配置类</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 微信支付相关参数</span></span><br><span class="line"><span class="comment"># 商户号</span></span><br><span class="line"><span class="meta">wxpay.mch-id</span>=<span class="string">1558950191</span></span><br><span class="line"><span class="comment"># 商户API证书序列号</span></span><br><span class="line"><span class="meta">wxpay.mch-serial-no</span>=<span class="string">34345964330B66427E0D3D28826C4993C77E631F</span></span><br><span class="line"><span class="comment"># 商户私钥文件</span></span><br><span class="line"><span class="meta">wxpay.private-key-path</span>=<span class="string">apiclient_key.pem</span></span><br><span class="line"><span class="comment"># APIv3密钥</span></span><br><span class="line"><span class="meta">wxpay.api-v3-key</span>=<span class="string">UDuLFDcmy5Eb6o0nTNZdu6ek4DDh4K8B</span></span><br><span class="line"><span class="comment"># APPID</span></span><br><span class="line"><span class="meta">wxpay.appid</span>=<span class="string">wx74862e0dfcf69954</span></span><br><span class="line"><span class="comment"># 微信服务器地址</span></span><br><span class="line"><span class="meta">wxpay.domain</span>=<span class="string">https://api.mch.weixin.qq.com</span></span><br><span class="line"><span class="comment"># 接收结果通知地址</span></span><br><span class="line"><span class="meta">wxpay.notify-domain</span>=<span class="string">https://7d92-115-171-63-135.ngrok.io</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建 WxPayConfig</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:wxpay.properties"</span>) <span class="comment">//读取配置文件</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix=<span class="string">"wxpay"</span>) <span class="comment">//读取wxpay节点</span></span><br><span class="line"><span class="meta">@Data</span> <span class="comment">//使用set方法将wxpay节点中的值填充到当前类的属性中</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxPayConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 商户号</span></span><br><span class="line">    <span class="keyword">private</span> String mchId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 商户API证书序列号</span></span><br><span class="line">    <span class="keyword">private</span> String mchSerialNo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 商户私钥文件</span></span><br><span class="line">    <span class="keyword">private</span> String privateKeyPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// APIv3密钥</span></span><br><span class="line">    <span class="keyword">private</span> String apiV3Key;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// APPID</span></span><br><span class="line">    <span class="keyword">private</span> String appid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 微信服务器地址</span></span><br><span class="line">    <span class="keyword">private</span> String domain;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接收结果通知地址</span></span><br><span class="line">    <span class="keyword">private</span> String notifyDomain;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中驼峰风格与配置文件中划线风格能够相互映射</p>
<p>mchId &lt;—-&gt; mch-id</p>
<ul>
<li>创建 TestController</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api</span>(<span class="string">"测试控制器"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api/test"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span>   <span class="comment">//将WxPayConfig注入</span></span><br><span class="line">    <span class="keyword">private</span> WxPayConfig wxPayConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">getWxPay</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String mchId = wxPayConfig.getMchId();  <span class="comment">//获取商户ID</span></span><br><span class="line">        <span class="keyword">return</span> R.ok().data(<span class="string">"mchId"</span>, mchId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进入接口文档页面</p>
<img src='/img/springboot/4/6.png'>

<p>成功获取到商户 ID</p>
<hr>
<h2 id="加载商户私钥"><a href="#加载商户私钥" class="headerlink" title="加载商户私钥"></a>加载商户私钥</h2><p>将商户私钥文件添加到项目根目录</p>
<p>引入微信支付 sdk 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.wechatpay-apiv3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>wechatpay-apache-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 WxPayConfig 文件添加代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取商户私钥文件</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> PrivateKey <span class="title">getPrivateKey</span><span class="params">(String filename)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PemUtil.loadPrivateKey(<span class="keyword">new</span> FileInputStream(filename));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"私钥文件不存在"</span>,e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>暂时将上方代码改为 public，在 SpringBoot 提供的测试类中修改其中代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> WxPayConfig wxPayConfig;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testGetPrivateKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取私钥路径</span></span><br><span class="line">    String privateKeyPath = wxPayConfig.getPrivateKeyPath();</span><br><span class="line"></span><br><span class="line">    PrivateKey privateKey = wxPayConfig.getPrivateKey(privateKeyPath);</span><br><span class="line"></span><br><span class="line">    System.out.println(privateKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src='/img/springboot/4/7.png'>

<p>成功获取商户私钥，将获取方法改回 private</p>
<hr>
<h2 id="获取验签器和-HttpClient"><a href="#获取验签器和-HttpClient" class="headerlink" title="获取验签器和 HttpClient"></a>获取验签器和 HttpClient</h2><p>在 WxPayConfig 继续添加代码，此处需要从微信提供的官方文档获取功能代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ScheduledUpdateCertificatesVerifier <span class="title">getVerifier</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">"获取签名验证器"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取商户私钥</span></span><br><span class="line">    PrivateKey privateKey = getPrivateKey(privateKeyPath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//私钥签名对象：平台做签名工作需要</span></span><br><span class="line">    PrivateKeySigner privateKeySigner = <span class="keyword">new</span> PrivateKeySigner(mchSerialNo, privateKey);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//身份认证对象</span></span><br><span class="line">    WechatPay2Credentials wechatPay2Credentials = <span class="keyword">new</span> WechatPay2Credentials(mchId, privateKeySigner);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用定时更新的签名验证器，不需要传入证书</span></span><br><span class="line">    ScheduledUpdateCertificatesVerifier verifier = <span class="keyword">new</span> ScheduledUpdateCertificatesVerifier(</span><br><span class="line">            wechatPay2Credentials,</span><br><span class="line">            apiV3Key.getBytes(StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> verifier;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"wxPayClient"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> CloseableHttpClient <span class="title">getWxPayClient</span><span class="params">(ScheduledUpdateCertificatesVerifier verifier)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">"获取httpClient"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取商户私钥</span></span><br><span class="line">    PrivateKey privateKey = getPrivateKey(privateKeyPath);</span><br><span class="line"></span><br><span class="line">    WechatPayHttpClientBuilder builder = WechatPayHttpClientBuilder.create()</span><br><span class="line">            .withMerchant(mchId, mchSerialNo, privateKey)</span><br><span class="line">            .withValidator(<span class="keyword">new</span> WechatPay2Validator(verifier));</span><br><span class="line">    <span class="comment">// ... 接下来，你仍然可以通过builder设置各种参数，来配置你的HttpClient</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过WechatPayHttpClientBuilder构造的HttpClient，会自动的处理签名和验签，并进行证书自动更新</span></span><br><span class="line">    CloseableHttpClient httpClient = builder.build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> httpClient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="微信支付-API-字典"><a href="#微信支付-API-字典" class="headerlink" title="微信支付 API 字典"></a>微信支付 API 字典</h2><p>将官方提供的各个 API 接口做枚举形式进行引入</p>
<ul>
<li>PayType（支付类型）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span> <span class="comment">//定义为全参函数</span></span><br><span class="line"><span class="meta">@Getter</span> <span class="comment">//自动生成get方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> PayType &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    WXPAY(<span class="string">"微信"</span>),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 支付宝（暂时忽略）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ALIPAY(<span class="string">"支付宝"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>OrderStatus（订单状态）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> OrderStatus &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 未支付</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    NOTPAY(<span class="string">"未支付"</span>),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 支付成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SUCCESS(<span class="string">"支付成功"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 已关闭</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CLOSED(<span class="string">"超时已关闭"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 已取消</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CANCEL(<span class="string">"用户已取消"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退款中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    REFUND_PROCESSING(<span class="string">"退款中"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 已退款</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    REFUND_SUCCESS(<span class="string">"已退款"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退款异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    REFUND_ABNORMAL(<span class="string">"退款异常"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>WxApiType（集合操作订单的 API）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> WxApiType &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Native下单，其中地址会与配置文件中定义的地址进行组装成完整地址</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	NATIVE_PAY(<span class="string">"/v3/pay/transactions/native"</span>),</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 查询订单</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ORDER_QUERY_BY_NO(<span class="string">"/v3/pay/transactions/out-trade-no/%s"</span>),</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 关闭订单</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	CLOSE_ORDER_BY_NO(<span class="string">"/v3/pay/transactions/out-trade-no/%s/close"</span>),</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 申请退款</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	DOMESTIC_REFUNDS(<span class="string">"/v3/refund/domestic/refunds"</span>),</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 查询单笔退款</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	DOMESTIC_REFUNDS_QUERY(<span class="string">"/v3/refund/domestic/refunds/%s"</span>),</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 申请交易账单</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	TRADE_BILLS(<span class="string">"/v3/bill/tradebill"</span>),</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 申请资金账单</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	FUND_FLOW_BILLS(<span class="string">"/v3/bill/fundflowbill"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 类型</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>WxNotifyType（交易通知）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> WxNotifyType &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 支付通知</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	NATIVE_NOTIFY(<span class="string">"/api/wx-pay/native/notify"</span>),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 退款结果通知</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	REFUND_NOTIFY(<span class="string">"/api/wx-pay/refunds/notify"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 类型</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>WxRefundStatus（退款状态）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> WxRefundStatus &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退款成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SUCCESS(<span class="string">"SUCCESS"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退款关闭</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CLOSED(<span class="string">"CLOSED"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退款处理中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PROCESSING(<span class="string">"PROCESSING"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退款异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ABNORMAL(<span class="string">"ABNORMAL"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>WxTradeState（支付状态）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> WxTradeState &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 支付成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SUCCESS(<span class="string">"SUCCESS"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 未支付</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    NOTPAY(<span class="string">"NOTPAY"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 已关闭</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CLOSED(<span class="string">"CLOSED"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转入退款</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    REFUND(<span class="string">"REFUND"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="工具类"><a href="#工具类" class="headerlink" title="工具类"></a>工具类</h2><ul>
<li>OrderNoUtils（订单号工具类）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderNoUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取订单编号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getOrderNo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ORDER_"</span> + getNo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取退款单编号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getRefundNo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"REFUND_"</span> + getNo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取编号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getNo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMddHHmmss"</span>);</span><br><span class="line">        String newDate = sdf.format(<span class="keyword">new</span> Date());</span><br><span class="line">        String result = <span class="string">""</span>;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            result += random.nextInt(<span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newDate + result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>HttpUtils（回调请求处理）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将通知参数转化为字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">readData</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        BufferedReader br = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            StringBuilder result = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            br = request.getReader();</span><br><span class="line">            <span class="keyword">for</span> (String line; (line = br.readLine()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">                <span class="keyword">if</span> (result.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    result.append(<span class="string">"\n"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                result.append(line);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (br != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    br.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Native-支付"><a href="#Native-支付" class="headerlink" title="Native 支付"></a>Native 支付</h2><ul>
<li>于 R.java 添加注解</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Accessors</span>(chain = <span class="keyword">true</span>)    <span class="comment">//R可以进行链式操作</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建 WxPayController 类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j  <span class="comment">//注入log对象，可以打印日志</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"api/wx-pay"</span>)</span><br><span class="line"><span class="meta">@Api</span>(<span class="string">"微信支付API"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxPayController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> WxPayService wxPayService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation</span>(<span class="string">"调用统一下单API，生成支付二维码"</span>)</span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"native/&#123;productId&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">nativePay</span><span class="params">(@PathVariable <span class="keyword">long</span> productId)</span></span>&#123;   <span class="comment">//参数向前端传递了商品id</span></span><br><span class="line">        log.info(<span class="string">"发起支付请求"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回支付二维码链接和订单号</span></span><br><span class="line">        Map&lt;String,Object&gt; map = wxPayService.nativePay(productId)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> R.ok().setData(map);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建 WxPayService 接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WxPayService</span> </span>&#123;</span><br><span class="line">    <span class="function">Map&lt;String, Object&gt; <span class="title">nativePay</span><span class="params">(Long productId)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建 WxPayServiceImpl 实现类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxPayServiceImpl</span> <span class="keyword">implements</span> <span class="title">WxPayService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> WxPayConfig wxPayConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CloseableHttpClient wxPayClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">nativePay</span><span class="params">(Long productId)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"生成订单"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成订单</span></span><br><span class="line">        OrderInfo orderInfo = <span class="keyword">new</span> OrderInfo();</span><br><span class="line">        orderInfo.setTitle(<span class="string">"test"</span>);</span><br><span class="line">        orderInfo.setOrderNo(OrderNoUtils.getOrderNo());    <span class="comment">//订单号</span></span><br><span class="line">        orderInfo.setProductId(productId);  <span class="comment">//订单号</span></span><br><span class="line">        orderInfo.setTotalFee(<span class="number">1</span>);    <span class="comment">//订单金额（单位：分）</span></span><br><span class="line">        orderInfo.setOrderStatus(OrderStatus.NOTPAY.getType());   <span class="comment">//订单状态</span></span><br><span class="line">        <span class="comment">//orderInfo.setCodeUrl();     //二维码链接</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用统一下单API，参数为组装的支付链接</span></span><br><span class="line">        HttpPost httpPost = <span class="keyword">new</span> HttpPost(wxPayConfig.getDomain().concat(WxApiType.NATIVE_PAY.getType()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 请求body参数，获取各项参数</span></span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        Map paramsMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        paramsMap.put(<span class="string">"appid"</span>, wxPayConfig.getAppid());</span><br><span class="line">        paramsMap.put(<span class="string">"mchid"</span>, wxPayConfig.getMchId());</span><br><span class="line">        paramsMap.put(<span class="string">"description"</span>, orderInfo.getTitle());</span><br><span class="line">        paramsMap.put(<span class="string">"out_trade_no"</span>, orderInfo.getOrderNo());</span><br><span class="line">        paramsMap.put(<span class="string">"notify_url"</span>, wxPayConfig.getNotifyDomain().concat(WxNotifyType.NATIVE_NOTIFY.getType()));</span><br><span class="line"></span><br><span class="line">        Map amountMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        amountMap.put(<span class="string">"total"</span>, orderInfo.getTotalFee());</span><br><span class="line">        amountMap.put(<span class="string">"currency"</span>, <span class="string">"CNY"</span>);</span><br><span class="line"></span><br><span class="line">        paramsMap.put(<span class="string">"amount"</span>, amountMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将参数转换成json字符串</span></span><br><span class="line">        String jsonParams = gson.toJson(paramsMap);</span><br><span class="line">        log.info(<span class="string">"请求参数 ===&gt; &#123;&#125;"</span> + jsonParams);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置Http请求，</span></span><br><span class="line">        StringEntity entity = <span class="keyword">new</span> StringEntity(jsonParams,<span class="string">"utf-8"</span>);</span><br><span class="line">        entity.setContentType(<span class="string">"application/json"</span>);</span><br><span class="line">        httpPost.setEntity(entity);</span><br><span class="line">        httpPost.setHeader(<span class="string">"Accept"</span>, <span class="string">"application/json"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//完成签名并执行请求</span></span><br><span class="line">        CloseableHttpResponse response = wxPayClient.execute(httpPost);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String bodyAsString = EntityUtils.toString(response.getEntity());<span class="comment">//响应体</span></span><br><span class="line">            <span class="keyword">int</span> statusCode = response.getStatusLine().getStatusCode();<span class="comment">//响应状态码</span></span><br><span class="line">            <span class="keyword">if</span> (statusCode == <span class="number">200</span>) &#123; <span class="comment">//处理成功</span></span><br><span class="line">                log.info(<span class="string">"成功, 返回结果 = "</span> + bodyAsString);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (statusCode == <span class="number">204</span>) &#123; <span class="comment">//处理成功，无返回Body</span></span><br><span class="line">                log.info(<span class="string">"成功"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.info(<span class="string">"Native下单失败,响应码 = "</span> + statusCode+ <span class="string">",返回结果 = "</span> + bodyAsString);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"request failed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//响应结果</span></span><br><span class="line">            Map&lt;String, String&gt; resultMap = gson.fromJson(bodyAsString, HashMap<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="comment">//二维码</span></span><br><span class="line">            String codeUrl = resultMap.get(<span class="string">"code_url"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//保存二维码</span></span><br><span class="line"><span class="comment">//            String orderNo = orderInfo.getOrderNo();</span></span><br><span class="line"><span class="comment">//            orderInfoService.saveCodeUrl(orderNo, codeUrl);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//返回二维码</span></span><br><span class="line">            Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            map.put(<span class="string">"codeUrl"</span>, codeUrl);</span><br><span class="line">            map.put(<span class="string">"orderNo"</span>, orderInfo.getOrderNo());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            response.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动项目，进入接口文档测试页面，进入支付接口测试，输入商品ID 1。</p>
<img src='/img/springboot/4/8.png'>

<p>成功获取</p>
<p>支付结果根据获取的响应码进行调整</p>
<p>前后端进行数据交互的是前端通过 axios 引入 ajax 请求，向后端接口请求数据，后端收到请请发送数据，前端接收到的数据需要调用微信提供的网络接口，因此前端 axios 设置的请求时间不宜过短，防止因为网络环境原因导致前端报错。</p>
<hr>
<h2 id="存入数据库"><a href="#存入数据库" class="headerlink" title="存入数据库"></a>存入数据库</h2><ul>
<li>于 OrderInfoService 接口中创建抽象方法（该方法用于通过商品 ID 生成订单）：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">OrderInfo <span class="title">createOrderByProductId</span><span class="params">(Long productId)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>在 OrderInfoServiceImpl 中生成实现类，并添加生成订单的各类操作</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderInfoServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">OrderInfoMapper</span>, <span class="title">OrderInfo</span>&gt; <span class="keyword">implements</span> <span class="title">OrderInfoService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ProductMapper productMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OrderInfo <span class="title">createOrderByProductId</span><span class="params">(Long productId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取商品信息</span></span><br><span class="line">        Product product = productMapper.selectById(productId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成订单</span></span><br><span class="line">        OrderInfo orderInfo = <span class="keyword">new</span> OrderInfo();</span><br><span class="line">        orderInfo.setTitle(product.getTitle());</span><br><span class="line">        orderInfo.setOrderNo(OrderNoUtils.getOrderNo());    <span class="comment">//订单号</span></span><br><span class="line">        orderInfo.setProductId(productId);  <span class="comment">//订单号</span></span><br><span class="line">        orderInfo.setTotalFee(product.getPrice());    <span class="comment">//订单金额（单位：分）</span></span><br><span class="line">        orderInfo.setOrderStatus(OrderStatus.NOTPAY.getType());   <span class="comment">//订单状态</span></span><br><span class="line">        baseMapper.insert(orderInfo);   <span class="comment">//存入数据库</span></span><br><span class="line">        <span class="keyword">return</span> orderInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改 WxPayServiceImpl</li>
</ul>
<p>添加以下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> OrderInfoService orderInfoService;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改生成订单处代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成订单</span></span><br><span class="line">OrderInfo orderInfo = orderInfoService.createOrderByProductId(productId);</span><br></pre></td></tr></table></figure>

<p>到目前为止在点击确认支付后可以在数据库创建响应订单，但反复点击确认支付会创建多个订单，对服务器造成较大压力，因此要进行优化。</p>
<hr>
<h2 id="获取已存在的订单"><a href="#获取已存在的订单" class="headerlink" title="获取已存在的订单"></a>获取已存在的订单</h2><ul>
<li>于 OrderInfoServiceImpl 中的 createOrderByProductId 方法中添加查询操作</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取已存在但未支付的订单</span></span><br><span class="line">OrderInfo orderInfo = <span class="keyword">this</span>.getNoPayOrderByProductId(productId);</span><br><span class="line"><span class="keyword">if</span>(orderInfo != <span class="keyword">null</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> orderInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>并在该方法外部添加查询方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据商品ID查询当前未支付的订单</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> OrderInfo <span class="title">getNoPayOrderByProductId</span><span class="params">(Long productId)</span></span>&#123;</span><br><span class="line">    QueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(<span class="string">"product_id"</span>, productId);   <span class="comment">//判断数据库中的product_id 与 productId 是否相等</span></span><br><span class="line">    queryWrapper.eq(<span class="string">"order_status"</span>, OrderStatus.NOTPAY.getType());</span><br><span class="line">    OrderInfo orderInfo = baseMapper.selectOne(queryWrapper);</span><br><span class="line">    <span class="keyword">return</span> orderInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其原理就是查询传入的商品 ID，根据该ID查询订单表中是否存在相同商品 ID 的订单，如果有，再查询订单状态是否为未支付，如果是，直接返回未支付的订单给用户，不再创建新的订单。</p>
<p>测试：</p>
<img src='/img/springboot/4/9.png'>

<p>多次点击后仍然只存在一个订单。</p>
<hr>
<h2 id="存储二维码"><a href="#存储二维码" class="headerlink" title="存储二维码"></a>存储二维码</h2><p>为防止用户重复下载订单，重复调用统一下单接口，要将产生的二维码和订单同时存储。</p>
<ul>
<li>于 OrderInfoService 接口中添加抽象方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveCodeUrl</span><span class="params">(String orderNo,String codeUrl)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>在其实现类生成实现方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//存储订单二维码</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveCodeUrl</span><span class="params">(String orderNo, String codeUrl)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//查询条件</span></span><br><span class="line">    QueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(<span class="string">"order_no"</span>, orderNo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//要更新的数据</span></span><br><span class="line">    OrderInfo orderInfo = <span class="keyword">new</span> OrderInfo();</span><br><span class="line">    orderInfo.setCodeUrl(codeUrl);</span><br><span class="line"></span><br><span class="line">    baseMapper.update(orderInfo, queryWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>于 WxPayServiceImpl 中调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">…………</span><br><span class="line">    <span class="comment">//二维码</span></span><br><span class="line">    codeUrl = resultMap.get(<span class="string">"code_url"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存二维码</span></span><br><span class="line">    String orderNo = orderInfo.getOrderNo();</span><br><span class="line">    orderInfoService.saveCodeUrl(orderNo, codeUrl);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回二维码</span></span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">"codeUrl"</span>, codeUrl);</span><br><span class="line">…………</span><br></pre></td></tr></table></figure>

<ul>
<li>在生成订单方法下进行健壮性判断</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成订单</span></span><br><span class="line">OrderInfo orderInfo = orderInfoService.createOrderByProductId(productId);</span><br><span class="line">String codeUrl = orderInfo.getCodeUrl();</span><br><span class="line"><span class="keyword">if</span>(orderInfo != <span class="keyword">null</span> &amp;&amp; !StringUtils.isEmpty(codeUrl))&#123;</span><br><span class="line">    <span class="comment">//返回二维码</span></span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">"codeUrl"</span>, codeUrl);</span><br><span class="line">    map.put(<span class="string">"orderNo"</span>, orderInfo.getOrderNo());</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当订单已存在且二维码链接不为空时，直接返回存在的二维码链接和订单号</p>
<hr>
<h2 id="显示订单列表"><a href="#显示订单列表" class="headerlink" title="显示订单列表"></a>显示订单列表</h2><ul>
<li>创建 OrderInfoController</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api/order-info"</span>)</span><br><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"商品订单管理"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderInfoController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderInfoService orderInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/list"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">list</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;OrderInfo&gt; list = orderInfoService.listOrderByCreateTimeDesc();</span><br><span class="line">        <span class="keyword">return</span> R.ok().data(<span class="string">"list"</span>, list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>于 OrderInfoService 添加抽象方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;OrderInfo&gt; <span class="title">listOrderByCreateTimeDesc</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>于其实现类中添加实现方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询订单列表，并倒序排序</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;OrderInfo&gt; <span class="title">listOrderByCreateTimeDesc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    QueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.orderByDesc(<span class="string">"create_time"</span>);    <span class="comment">//根据该字段倒序排序</span></span><br><span class="line">    <span class="keyword">return</span> baseMapper.selectList(queryWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行测试：</p>
<img src='/img/springboot/4/10.png'>

<p>可以看到订单信息已经成功倒序排列展示</p>
<hr>
<h2 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h2><p>此处用的软件是 ngrok</p>
<p>启动软件后先绑定官网提供的个人账户 token（以下 token 仅为展示）</p>
<img src='/img/springboot/4/11.png'>

<p>通过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngrok http 8090</span><br></pre></td></tr></table></figure>

<p>映射后端的端口号</p>
<img src='/img/springboot/4/12.png'>

<p>可以看到提供的两个外网映射地址（建议使用 https）</p>
<img src='/img/springboot/4/13.png'>

<p>通过外网的映射地址同样可以访问到后端数据，内网穿透映射成功实现</p>
<p>相对应的在 SpringBoot 配置文件中存在配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接收结果通知地址</span></span><br><span class="line"><span class="meta">wxpay.notify-domain</span>=<span class="string">https://f779-117-32-218-87.ngrok.io</span></span><br></pre></td></tr></table></figure>

<p>由于软件限制，每次重新开启外网映射得到的映射地址是不同的，因此要对此处的配置地址随时调整</p>
<hr>
<h2 id="接收通知和返回应答"><a href="#接收通知和返回应答" class="headerlink" title="接收通知和返回应答"></a>接收通知和返回应答</h2><ul>
<li>于 WxPayController 创建一个通知接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/native/notify"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">nativeNotify</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span>&#123;</span><br><span class="line">       Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">       Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();   <span class="comment">//应答对象</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">//处理通知参数</span></span><br><span class="line">           String body = HttpUtils.readData(request);</span><br><span class="line">           Map&lt;String,Object&gt; bodyMap = gson.fromJson(body, HashMap<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">           log.info(<span class="string">"支付通知的id ===&gt; &#123;&#125;"</span>,bodyMap.get(<span class="string">"id"</span>));</span><br><span class="line">           log.info(<span class="string">"支付通知完整数据 ===&gt; &#123;&#125;"</span>,body);</span><br><span class="line"></span><br><span class="line">           <span class="comment">//<span class="doctag">TODO:</span> 签名的验证</span></span><br><span class="line">           <span class="comment">//<span class="doctag">TODO:</span> 处理订单</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">//成功应答</span></span><br><span class="line">           response.setStatus(<span class="number">200</span>);</span><br><span class="line">           map.put(<span class="string">"code"</span>, <span class="string">"SUCCESS"</span>);</span><br><span class="line">           map.put(<span class="string">"message"</span>,<span class="string">"成功"</span>);</span><br><span class="line">           <span class="keyword">return</span> gson.toJson(map);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (JsonSyntaxException e) &#123;</span><br><span class="line">           <span class="comment">//失败应答</span></span><br><span class="line">           response.setStatus(<span class="number">500</span>);</span><br><span class="line">           map.put(<span class="string">"code"</span>, <span class="string">"ERROR"</span>);</span><br><span class="line">           map.put(<span class="string">"message"</span>,<span class="string">"失败"</span>);</span><br><span class="line">           <span class="keyword">return</span> gson.toJson(map);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>重启项目进行付款测试：</p>
<img src='/img/springboot/4/14.png'>

<p>成功付款后获得支付通知</p>
<hr>
<h2 id="验签"><a href="#验签" class="headerlink" title="验签"></a>验签</h2><p>将 wxpay 的依赖包中的 WechatPay2Validator 文件下载到本地，然后复制到项目 util 包内重命名为：WechatPay2ValidatorRequest</p>
<ul>
<li>修改 WechatPay2ValidatorRequest 之中的代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WechatPay2ValidatorRequest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(WechatPay2ValidatorRequest<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 应答超时时间，单位为分钟</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> RESPONSE_EXPIRED_MINUTES = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Verifier verifier;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String requestId;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String body;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WechatPay2ValidatorRequest</span><span class="params">(Verifier verifier, String requestId, String body)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.verifier = verifier;</span><br><span class="line">        <span class="keyword">this</span>.requestId = requestId;</span><br><span class="line">        <span class="keyword">this</span>.body = body;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> IllegalArgumentException <span class="title">parameterError</span><span class="params">(String message, Object... args)</span> </span>&#123;</span><br><span class="line">        message = String.format(message, args);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"parameter error: "</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> IllegalArgumentException <span class="title">verifyFail</span><span class="params">(String message, Object... args)</span> </span>&#123;</span><br><span class="line">        message = String.format(message, args);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"signature verify fail: "</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">validate</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//处理请求参数</span></span><br><span class="line">            validateParameters(request);</span><br><span class="line">            <span class="comment">//构造验签名串</span></span><br><span class="line">            String message = buildMessage(request);</span><br><span class="line">            String serial = request.getHeader(WECHAT_PAY_SERIAL);</span><br><span class="line">            String signature = request.getHeader(WECHAT_PAY_SIGNATURE);</span><br><span class="line">            <span class="comment">//验签</span></span><br><span class="line">            <span class="keyword">if</span> (!verifier.verify(serial, message.getBytes(StandardCharsets.UTF_8), signature)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> verifyFail(<span class="string">"serial=[%s] message=[%s] sign=[%s], request-id=[%s]"</span>,</span><br><span class="line">                        serial, message, signature, requestId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            log.warn(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">validateParameters</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> ensure HEADER_WECHAT_PAY_TIMESTAMP at last</span></span><br><span class="line">        String[] headers = &#123;WECHAT_PAY_SERIAL, WECHAT_PAY_SIGNATURE, WECHAT_PAY_NONCE, WECHAT_PAY_TIMESTAMP&#125;;</span><br><span class="line"></span><br><span class="line">        String header = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (String headerName : headers) &#123;</span><br><span class="line">            header = request.getHeader(headerName);</span><br><span class="line">            <span class="keyword">if</span> (header == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> parameterError(<span class="string">"empty [%s], request-id=[%s]"</span>, headerName, requestId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断请求是否过期</span></span><br><span class="line">        String timestampStr = header;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Instant responseTime = Instant.ofEpochSecond(Long.parseLong(timestampStr));</span><br><span class="line">            <span class="comment">// 拒绝过期请求</span></span><br><span class="line">            <span class="keyword">if</span> (Duration.between(responseTime, Instant.now()).abs().toMinutes() &gt;= RESPONSE_EXPIRED_MINUTES) &#123;</span><br><span class="line">                <span class="keyword">throw</span> parameterError(<span class="string">"timestamp=[%s] expires, request-id=[%s]"</span>, timestampStr, requestId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DateTimeException | NumberFormatException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> parameterError(<span class="string">"invalid timestamp=[%s], request-id=[%s]"</span>, timestampStr, requestId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> String <span class="title">buildMessage</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String timestamp = request.getHeader(WECHAT_PAY_TIMESTAMP);</span><br><span class="line">        String nonce = request.getHeader(WECHAT_PAY_NONCE);</span><br><span class="line">        <span class="keyword">return</span> timestamp + <span class="string">"\n"</span></span><br><span class="line">                + nonce + <span class="string">"\n"</span></span><br><span class="line">                + body + <span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> String <span class="title">getResponseBody</span><span class="params">(CloseableHttpResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        HttpEntity entity = response.getEntity();</span><br><span class="line">        <span class="keyword">return</span> (entity != <span class="keyword">null</span> &amp;&amp; entity.isRepeatable()) ? EntityUtils.toString(entity) : <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>于 WxPayController 注入接口，并修改 try-catch 中的代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> Verifier verifier;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//处理通知参数</span></span><br><span class="line">            String body = HttpUtils.readData(request);</span><br><span class="line">            Map&lt;String,Object&gt; bodyMap = gson.fromJson(body, HashMap<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            String requestId = (String)bodyMap.get(<span class="string">"id"</span>);</span><br><span class="line">            log.info(<span class="string">"支付通知的id ===&gt; &#123;&#125;"</span>,bodyMap.get(<span class="string">"id"</span>));</span><br><span class="line">            log.info(<span class="string">"支付通知完整数据 ===&gt; &#123;&#125;"</span>,body);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//<span class="doctag">TODO:</span> 签名的验证</span></span><br><span class="line">            WechatPay2ValidatorRequest wechatPay2ValidatorRequest = <span class="keyword">new</span> WechatPay2ValidatorRequest(verifier, requestId, body);</span><br><span class="line">            <span class="keyword">if</span>(!wechatPay2ValidatorRequest.validate(request))&#123;</span><br><span class="line">                log.error(<span class="string">"通知验签失败"</span>);</span><br><span class="line">                <span class="comment">//失败应答</span></span><br><span class="line">                response.setStatus(<span class="number">500</span>);</span><br><span class="line">                map.put(<span class="string">"code"</span>, <span class="string">"ERROR"</span>);</span><br><span class="line">                map.put(<span class="string">"message"</span>,<span class="string">"通知验签失败"</span>);</span><br><span class="line">                <span class="keyword">return</span> gson.toJson(map);</span><br><span class="line">            &#125;</span><br><span class="line">    ……</span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="报文解密"><a href="#报文解密" class="headerlink" title="报文解密"></a>报文解密</h2><ul>
<li>于 WxPayController 的 //处理订单 注释下添加代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//<span class="doctag">TODO:</span> 处理订单</span></span><br><span class="line">wxPayService.processOrder(bodyMap);</span><br></pre></td></tr></table></figure>

<p>添加抽象方法，并添加实现方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processOrder</span><span class="params">(Map&lt;String, Object&gt; bodyMap)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"处理订单"</span>);</span><br><span class="line"></span><br><span class="line">        String plainTest = decryptFromResource(bodyMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//对称解密</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">decryptFromResource</span><span class="params">(Map&lt;String, Object&gt; bodyMap)</span> <span class="keyword">throws</span> GeneralSecurityException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"密文解密"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通知数据</span></span><br><span class="line">        Map&lt;String,String&gt; resourceMap = (Map&lt;String, String&gt;) bodyMap.get(<span class="string">"resource"</span>);</span><br><span class="line">        <span class="comment">//数据密文</span></span><br><span class="line">        String ciphertext = resourceMap.get(<span class="string">"ciphertext"</span>);</span><br><span class="line">        <span class="comment">//随机穿</span></span><br><span class="line">        String nonce = resourceMap.get(<span class="string">"nonce"</span>);</span><br><span class="line">        <span class="comment">//附加数据</span></span><br><span class="line">        String associated_data = resourceMap.get(<span class="string">"associated_data"</span>);</span><br><span class="line">        log.info(<span class="string">"密文 ===&gt; &#123;&#125;"</span>,ciphertext);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取解密工具</span></span><br><span class="line">        AesUtil aesUtil = <span class="keyword">new</span> AesUtil(wxPayConfig.getApiV3Key().getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="comment">//得到明文数据</span></span><br><span class="line">        String plainText = aesUtil.decryptToString(associated_data.getBytes(StandardCharsets.UTF_8), nonce.getBytes(StandardCharsets.UTF_8), ciphertext);</span><br><span class="line">        log.info(<span class="string">"明文 ===&gt; &#123;&#125;"</span>,plainText);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> plainText;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="更新订单状态、记录支付日志"><a href="#更新订单状态、记录支付日志" class="headerlink" title="更新订单状态、记录支付日志"></a>更新订单状态、记录支付日志</h2><ul>
<li>于 WxPayServiceImpl processOrder 方法内添加代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processOrder</span><span class="params">(Map&lt;String, Object&gt; bodyMap)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    log.info(<span class="string">"处理订单"</span>);</span><br><span class="line">    <span class="comment">//解密报文</span></span><br><span class="line">    String plainTest = decryptFromResource(bodyMap);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将明文转换为map</span></span><br><span class="line">    Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">    HashMap plainTextMap = gson.fromJson(plainTest, HashMap<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    String orderNo = (String) plainTextMap.get(<span class="string">"out_trade_no"</span>); <span class="comment">//获取订单号</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新订单状态</span></span><br><span class="line">    orderInfoService.updateStatusByOrderNo(orderNo,OrderStatus.SUCCESS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录支付日志</span></span><br><span class="line">    paymentInfoService.createPaymentInfo(plainTest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>生成 updateStatusByOrderNo 业务方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据订单号，更新订单状态</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateStatusByOrderNo</span><span class="params">(String orderNo, OrderStatus orderStatus)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">"更新订单状态 ===&gt; &#123;&#125;"</span>,orderStatus.getType());</span><br><span class="line"></span><br><span class="line">    QueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(<span class="string">"order_no"</span>, orderNo);</span><br><span class="line"></span><br><span class="line">    OrderInfo orderInfo = <span class="keyword">new</span> OrderInfo();</span><br><span class="line">    orderInfo.setOrderStatus(orderStatus.getType());</span><br><span class="line"></span><br><span class="line">    baseMapper.update(orderInfo, queryWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>生成 createPaymentInfo 业务方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentInfoServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">PaymentInfoMapper</span>, <span class="title">PaymentInfo</span>&gt; <span class="keyword">implements</span> <span class="title">PaymentInfoService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createPaymentInfo</span><span class="params">(String plainTest)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"记录支付日志"</span>);</span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        HashMap plainTextMap = gson.fromJson(plainTest, HashMap<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="comment">//订单号</span></span><br><span class="line">        String orderNo = (String) plainTextMap.get(<span class="string">"out_trade_no"</span>);</span><br><span class="line">        <span class="comment">//业务编号</span></span><br><span class="line">        String transactionId = (String) plainTextMap.get(<span class="string">"transaction_id"</span>);</span><br><span class="line">        <span class="comment">//业务类型</span></span><br><span class="line">        String tradeType = (String) plainTextMap.get(<span class="string">"trade_type"</span>);</span><br><span class="line">        <span class="comment">//交易状态</span></span><br><span class="line">        String tradeState = (String) plainTextMap.get(<span class="string">"trade_state"</span>);</span><br><span class="line">        <span class="comment">//用户支付金额</span></span><br><span class="line">        Map&lt;String,Object&gt; amount = (Map)plainTextMap.get(<span class="string">"amount"</span>);</span><br><span class="line">        <span class="comment">//实际支付金额</span></span><br><span class="line">        Integer payerTotal = ((Double) plainTextMap.get(<span class="string">"payer_total"</span>)).intValue();</span><br><span class="line"></span><br><span class="line">        PaymentInfo paymentInfo = <span class="keyword">new</span> PaymentInfo();</span><br><span class="line">        paymentInfo.setOrderNo(orderNo);</span><br><span class="line">        paymentInfo.setPaymentType(PayType.WXPAY.getType());</span><br><span class="line">        paymentInfo.setTransactionId(transactionId);</span><br><span class="line">        paymentInfo.setTradeType(tradeType);</span><br><span class="line">        paymentInfo.setTradeState(tradeState);</span><br><span class="line">        paymentInfo.setPayerTotal(payerTotal);</span><br><span class="line">        paymentInfo.setContent(plainTest);</span><br><span class="line"></span><br><span class="line">        baseMapper.insert(paymentInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="处理重复通知"><a href="#处理重复通知" class="headerlink" title="处理重复通知"></a>处理重复通知</h2><p>重复通知会在支付记录产生多条重复支付记录，因此要正确处理。</p>
<ul>
<li>于 processOrder //更新订单状态 注释前添加代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//处理重复的通知</span></span><br><span class="line">String orderStatus = orderInfoService.getOrderStatus(orderNo);</span><br><span class="line"><span class="keyword">if</span>(!OrderStatus.NOTPAY.getType().equals(orderStatus))&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现 getOrderStatus 方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getOrderStatus</span><span class="params">(String orderNo)</span> </span>&#123;</span><br><span class="line">    QueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(<span class="string">"order_no"</span>, orderNo);</span><br><span class="line">    OrderInfo orderInfo = baseMapper.selectOne(queryWrapper);</span><br><span class="line">    <span class="keyword">if</span>(orderInfo == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> orderInfo.getOrderStatus();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="数据锁（并发控制）"><a href="#数据锁（并发控制）" class="headerlink" title="数据锁（并发控制）"></a>数据锁（并发控制）</h2><ul>
<li>于 WxPayServiceImpl 中的 //处理重复通知 注释上方添加代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();     <span class="comment">//这个声明在WxPayServiceImpl 一开始</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(lock.tryLock())&#123; <span class="comment">//锁存在</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后将处理重复通知、更新订单状态和记录支付日志的功能调用代码放在锁判断语句中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(lock.tryLock())&#123; <span class="comment">//尝试获取锁，成功立即返回true，失败返回false，不会等待锁的释放</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//处理重复的通知</span></span><br><span class="line">    String orderStatus = orderInfoService.getOrderStatus(orderNo);</span><br><span class="line">    <span class="keyword">if</span>(!OrderStatus.NOTPAY.getType().equals(orderStatus))&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新订单状态</span></span><br><span class="line">    orderInfoService.updateStatusByOrderNo(orderNo,OrderStatus.SUCCESS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录支付日志</span></span><br><span class="line">    paymentInfoService.createPaymentInfo(plainTest);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">//释放锁</span></span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="定时查单"><a href="#定时查单" class="headerlink" title="定时查单"></a>定时查单</h2><p>如果用户扫码完成支付，则在一定时间内自动关闭二维码窗口。</p>
<ul>
<li>于 OrderInfoController 中添加代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询订单状态</span></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"query-order-status/&#123;orderNo&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">queryOrderStatus</span><span class="params">(@PathVariable String orderNo)</span></span>&#123;</span><br><span class="line">    String orderStatus = orderInfoService.getOrderStatus(orderNo);</span><br><span class="line">    <span class="keyword">if</span>(OrderStatus.SUCCESS.getType().equals(orderStatus))&#123;</span><br><span class="line">        <span class="keyword">return</span> R.ok().setMessage(<span class="string">"支付成功"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> R.ok().setCode(<span class="number">101</span>).setMessage(<span class="string">"支付中......"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过前端调用该接口，根据状态值判断是否关闭窗口</p>
<hr>
<h2 id="用户取消订单"><a href="#用户取消订单" class="headerlink" title="用户取消订单"></a>用户取消订单</h2><ul>
<li>于 WxPayController 中添加方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//取消订单</span></span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/cancel/&#123;orderNo&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">cancel</span><span class="params">(@PathVariable String orderNo)</span></span>&#123;</span><br><span class="line">    log.info(<span class="string">"取消订单"</span>);</span><br><span class="line">    wxPayService.cancelOrder(orderNo);</span><br><span class="line">    <span class="keyword">return</span> R.ok().setMessage(<span class="string">"订单已取消"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建业务方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用户取消订单</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelOrder</span><span class="params">(String orderNo)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用微信支付的关单接口</span></span><br><span class="line">        <span class="keyword">this</span>.closeOrder(orderNo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新商户端的订单状态</span></span><br><span class="line">        orderInfoService.updateStatusByOrderNo(orderNo, OrderStatus.CANCEL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关单接口调用</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeOrder</span><span class="params">(String orderNo)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"关单接口的调用，订单号 ===&gt; &#123;&#125;"</span>,orderNo);</span><br><span class="line">        <span class="comment">//创建远程请求对象</span></span><br><span class="line">        String url = String.format(WxApiType.CLOSE_ORDER_BY_NO.getType(), orderNo);</span><br><span class="line">        url = wxPayConfig.getDomain().concat(url);</span><br><span class="line">        HttpPost httpPost = <span class="keyword">new</span> HttpPost(url);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//组装json请求体</span></span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        Map&lt;String,String&gt; paramsMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        paramsMap.put(<span class="string">"mchid"</span>, wxPayConfig.getMchId());</span><br><span class="line">        String jsonParams = gson.toJson(paramsMap);</span><br><span class="line">        log.info(<span class="string">"请求参数 ===&gt; &#123;&#125;"</span>,jsonParams);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将请求参数设置到请求对象中</span></span><br><span class="line">        StringEntity entity = <span class="keyword">new</span> StringEntity(jsonParams,<span class="string">"utf-8"</span>);</span><br><span class="line">        entity.setContentType(<span class="string">"application/json"</span>);</span><br><span class="line">        httpPost.setEntity(entity);</span><br><span class="line">        httpPost.setHeader(<span class="string">"Accept"</span>, <span class="string">"application/json"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//完成签名并执行请求</span></span><br><span class="line">        CloseableHttpResponse response = wxPayClient.execute(httpPost);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> statusCode = response.getStatusLine().getStatusCode();<span class="comment">//响应状态码</span></span><br><span class="line">            <span class="keyword">if</span> (statusCode == <span class="number">200</span>) &#123; <span class="comment">//处理成功</span></span><br><span class="line">                log.info(<span class="string">"成功"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (statusCode == <span class="number">204</span>) &#123; <span class="comment">//处理成功，无返回Body</span></span><br><span class="line">                log.info(<span class="string">"成功"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.info(<span class="string">"Native下单失败,响应码 = "</span> + statusCode);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"request failed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            response.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>重新运行项目，前往前端进行测试</p>
<img src='/img/springboot/4/15.png'>

<p>订单已成功取消。</p>
<hr>
<h2 id="微信支付查询订单"><a href="#微信支付查询订单" class="headerlink" title="微信支付查询订单"></a>微信支付查询订单</h2><p>商家迟迟未收到异步通知的时候，主动调用查询接口查询订单，及时更改订单状态。</p>
<ul>
<li>于 WxPayController 中创建查单接口：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询订单</span></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/query/&#123;orderNo&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">queryOrder</span><span class="params">(@PathVariable String orderNo)</span></span>&#123;</span><br><span class="line">    log.info(<span class="string">"查询订单"</span>);</span><br><span class="line">    String result = wxPayService.queryOrder(orderNo);</span><br><span class="line">    <span class="keyword">return</span> R.ok().setMessage(<span class="string">"查询成功"</span>).setData(<span class="string">"result"</span>,result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现业务方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询订单</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">queryOrder</span><span class="params">(String orderNo)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"查单接口调用 ===&gt; &#123;&#125;"</span>,orderNo);</span><br><span class="line">        String url = String.format(WxApiType.ORDER_QUERY_BY_NO.getType(), orderNo);</span><br><span class="line">        url = wxPayConfig.getDomain().concat(url).concat(<span class="string">"?mchid="</span>).concat(wxPayConfig.getMchId());</span><br><span class="line">        HttpGet httpGet = <span class="keyword">new</span> HttpGet(url);</span><br><span class="line">        httpGet.setHeader(<span class="string">"Accept"</span>,<span class="string">"application/json"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//完成签名并执行请求</span></span><br><span class="line">        CloseableHttpResponse response = wxPayClient.execute(httpGet);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String bodyAsString = EntityUtils.toString(response.getEntity());<span class="comment">//响应体</span></span><br><span class="line">            <span class="keyword">int</span> statusCode = response.getStatusLine().getStatusCode();<span class="comment">//响应状态码</span></span><br><span class="line">            <span class="keyword">if</span> (statusCode == <span class="number">200</span>) &#123; <span class="comment">//处理成功</span></span><br><span class="line">                log.info(<span class="string">"成功, 返回结果 = "</span> + bodyAsString);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (statusCode == <span class="number">204</span>) &#123; <span class="comment">//处理成功，无返回Body</span></span><br><span class="line">                log.info(<span class="string">"成功"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.info(<span class="string">"Native下单失败,响应码 = "</span> + statusCode+ <span class="string">",返回结果 = "</span> + bodyAsString);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"request failed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> bodyAsString;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            response.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="引入定时任务"><a href="#引入定时任务" class="headerlink" title="引入定时任务"></a>引入定时任务</h2><ul>
<li>于主启动类引入 Spring Task ：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//引入定时任务 Spring Task</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建 WxPayTask：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span>  <span class="comment">//项目启动自动初始化</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxPayTask</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderInfoService orderInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每30秒查询一次超过5分钟未支付的订单</span></span><br><span class="line">    <span class="meta">@Scheduled</span>(cron = <span class="string">"0/30 * * * * ?"</span>) <span class="comment">//每30秒执行一次</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">orderConfirm</span><span class="params">()</span></span>&#123;</span><br><span class="line">        log.info(<span class="string">"orderConfirm 被执行......"</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;OrderInfo&gt; orderInfoList = orderInfoService.getNoPayOrderByDuration(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(OrderInfo orderInfo : orderInfoList)&#123;</span><br><span class="line">        String orderNo = orderInfo.getOrderNo();</span><br><span class="line">        log.warn(<span class="string">"超时订单 ===&gt; &#123;&#125;"</span>,orderNo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建 getNoPayOrderByDuration 业务方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询创建超过minutes分钟并未支付的订单</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;OrderInfo&gt; <span class="title">getNoPayOrderByDuration</span><span class="params">(<span class="keyword">int</span> minutes)</span> </span>&#123;</span><br><span class="line">    Instant instant = Instant.now().minus(Duration.ofMinutes(minutes)); <span class="comment">//当前时间减去minutes时间，得到minutes时间之前</span></span><br><span class="line"></span><br><span class="line">    QueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(<span class="string">"order_status"</span>, OrderStatus.NOTPAY.getType());</span><br><span class="line">    queryWrapper.le(<span class="string">"create_time"</span>, instant);    <span class="comment">//比较创建时间早于instant</span></span><br><span class="line"></span><br><span class="line">    List&lt;OrderInfo&gt; orderInfoList = baseMapper.selectList(queryWrapper);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> orderInfoList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="处理超时订单"><a href="#处理超时订单" class="headerlink" title="处理超时订单"></a>处理超时订单</h2><ul>
<li>于 WxPayTask 中添加代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> WxPayService wxPayService;</span><br><span class="line"></span><br><span class="line"><span class="comment">//每30秒查询一次超过5分钟未支付的订单</span></span><br><span class="line"><span class="meta">@Scheduled</span>(cron = <span class="string">"0/30 * * * * ?"</span>) <span class="comment">//每30秒执行一次</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">orderConfirm</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ……</span><br><span class="line">    ……</span><br><span class="line">    <span class="comment">//核实订单状态：调用微信支付查单接口</span></span><br><span class="line">    wxPayService.checkOrderStatus(orderNo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建 checkOrderStatus 业务方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据订单号调用微信支付查单接口，查询订单状态</span></span><br><span class="line">    <span class="comment">//如果订单已支付，更新商户端订单状态</span></span><br><span class="line">    <span class="comment">//如果未支付，则调用关单接口关闭订单吗，并更新商户端订单状态</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkOrderStatus</span><span class="params">(String orderNo)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.warn(<span class="string">"根据订单号，核实订单状态 ===&gt; &#123;&#125;"</span>,orderNo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用微信支付查单接口</span></span><br><span class="line">        String result = <span class="keyword">this</span>.queryOrder(orderNo);</span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        Map resultMap = gson.fromJson(result, HashMap<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="comment">//获取订单状态</span></span><br><span class="line">        Object tradeState = resultMap.get(<span class="string">"trade_state"</span>);</span><br><span class="line">        <span class="comment">//判断订单状态</span></span><br><span class="line">        <span class="keyword">if</span>(WxTradeState.SUCCESS.getType().equals(tradeState))&#123;</span><br><span class="line">            log.warn(<span class="string">"核实订单已支付 ===&gt; &#123;&#125;"</span>,orderNo);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果已支付，更新本地订单状态</span></span><br><span class="line">            orderInfoService.updateStatusByOrderNo(orderNo, OrderStatus.SUCCESS);</span><br><span class="line">            <span class="comment">//记录支付日志</span></span><br><span class="line">            paymentInfoService.createPaymentInfo(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(WxTradeState.NOTPAY.getType().equals(tradeState))&#123;</span><br><span class="line">            log.warn(<span class="string">"核实订单未支付 ===&gt; &#123;&#125;"</span>,orderNo);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果未支付，更新本地订单状态</span></span><br><span class="line">            <span class="keyword">this</span>.closeOrder(orderNo);</span><br><span class="line">            orderInfoService.updateStatusByOrderNo(orderNo, OrderStatus.CLOSED);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="申请退款"><a href="#申请退款" class="headerlink" title="申请退款"></a>申请退款</h2><ul>
<li>于 WxPayController 添加退款接口：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//申请退款</span></span><br><span class="line"><span class="meta">@ApiOperation</span>(<span class="string">"申请退款"</span>)</span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/refunds/&#123;orderNo&#125;/&#123;reason&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">refunds</span><span class="params">(@PathVariable String orderNo, @PathVariable String reason)</span></span>&#123;</span><br><span class="line">    log.info(<span class="string">"申请退款"</span>);</span><br><span class="line">    wxPayService.refund(orderNo,reason);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建 refund 业务方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//此处要有注入</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RefundInfoServiceImpl refundsInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//申请退款</span></span><br><span class="line">    <span class="meta">@Transactional</span>(rollbackFor = Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">Override</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">void</span> <span class="title">refund</span>(<span class="title">String</span> <span class="title">orderNo</span>, <span class="title">String</span> <span class="title">reason</span>) </span>&#123;</span><br><span class="line">        log.info(<span class="string">"创建退款单记录"</span>);</span><br><span class="line">        <span class="comment">//根据订单编号创建退款单</span></span><br><span class="line">        RefundInfo refundInfo = refundsInfoService.createRefundByOrderNo(orderNo,reason);</span><br><span class="line">        log.info(<span class="string">"调用退款 API"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用统一下单API</span></span><br><span class="line">        String url = wxPayConfig.getDomain().concat(WxApiType.DOMESTIC_REFUNDS.getType());</span><br><span class="line">        HttpPost httpPost = <span class="keyword">new</span> HttpPost(url);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建 createRefundByOrderNo 业务方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RefundInfoServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">RefundInfoMapper</span>, <span class="title">RefundInfo</span>&gt; <span class="keyword">implements</span> <span class="title">RefundInfoService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrderInfoService orderInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RefundInfo <span class="title">createRefundByOrderNo</span><span class="params">(String orderNo, String reason)</span></span>&#123;</span><br><span class="line">        <span class="comment">//根据订单号获取订单信息</span></span><br><span class="line">        OrderInfo orderInfo = orderInfoService.getOrderByOrderNo(orderNo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据订单号生成退款订单</span></span><br><span class="line">        RefundInfo refundInfo = <span class="keyword">new</span> RefundInfo();</span><br><span class="line">        refundInfo.setOrderNo(orderNo); <span class="comment">//订单编号</span></span><br><span class="line">        refundInfo.setRefundNo(OrderNoUtils.getRefundNo()); <span class="comment">//退款单编号</span></span><br><span class="line">        refundInfo.setTotalFee(orderInfo.getTotalFee());    <span class="comment">//原订单金额（分）</span></span><br><span class="line">        refundInfo.setRefund(orderInfo.getTotalFee());  <span class="comment">//退款金额</span></span><br><span class="line">        refundInfo.setReason(reason);   <span class="comment">//退款原因</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//保存退款单</span></span><br><span class="line">        baseMapper.insert(refundInfo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> refundInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建 getOrderByOrderNo 业务方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据订单号获取订单</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> OrderInfo <span class="title">getOrderByOrderNo</span><span class="params">(String orderNo)</span> </span>&#123;</span><br><span class="line">    QueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(<span class="string">"order_no"</span>, orderNo);</span><br><span class="line">    OrderInfo orderInfo = baseMapper.selectOne(queryWrapper);   <span class="comment">//根据比对信息查询数据库，并赋值给orderInfo</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> orderInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>于 WxPayServiceImpl 中添加方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//申请退款</span></span><br><span class="line">    <span class="meta">@Transactional</span>(rollbackFor = Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">Override</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">void</span> <span class="title">refund</span>(<span class="title">String</span> <span class="title">orderNo</span>, <span class="title">String</span> <span class="title">reason</span>) <span class="title">throws</span> <span class="title">IOException</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"创建退款单记录"</span>);</span><br><span class="line">        <span class="comment">//根据订单编号创建退款单</span></span><br><span class="line">        RefundInfo refundInfo = refundsInfoService.createRefundByOrderNo(orderNo,reason);</span><br><span class="line">        log.info(<span class="string">"调用退款 API"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用统一下单API</span></span><br><span class="line">        String url = wxPayConfig.getDomain().concat(WxApiType.DOMESTIC_REFUNDS.getType());</span><br><span class="line">        HttpPost httpPost = <span class="keyword">new</span> HttpPost(url);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 请求 body 参数</span></span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        Map paramsMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        paramsMap.put(<span class="string">"out_trade_no"</span>, orderNo);</span><br><span class="line">        paramsMap.put(<span class="string">"out_refund_no"</span>, refundInfo.getRefundNo());</span><br><span class="line">        paramsMap.put(<span class="string">"reason"</span>, reason);</span><br><span class="line">        paramsMap.put(<span class="string">"notify_url"</span>, wxPayConfig.getNotifyDomain().concat(WxNotifyType.REFUND_NOTIFY.getType()));</span><br><span class="line"></span><br><span class="line">        Map amountMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        amountMap.put(<span class="string">"refund"</span>, refundInfo.getRefund());    <span class="comment">//退款金额</span></span><br><span class="line">        amountMap.put(<span class="string">"total"</span>, refundInfo.getTotalFee());   <span class="comment">//原订单金额</span></span><br><span class="line">        amountMap.put(<span class="string">"currency"</span>, <span class="string">"CNY"</span>);</span><br><span class="line"></span><br><span class="line">        paramsMap.put(<span class="string">"amount"</span>, amountMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将参数转换成json字符串</span></span><br><span class="line">        String jsonParams = gson.toJson(paramsMap);</span><br><span class="line">        log.info(<span class="string">"请求参数 ===&gt; &#123;&#125;"</span> + jsonParams);</span><br><span class="line"></span><br><span class="line">        StringEntity entity = <span class="keyword">new</span> StringEntity(jsonParams,<span class="string">"utf-8"</span>);</span><br><span class="line">        entity.setContentType(<span class="string">"application/json"</span>);</span><br><span class="line">        httpPost.setEntity(entity);</span><br><span class="line">        httpPost.setHeader(<span class="string">"Accept"</span>, <span class="string">"application/json"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//完成签名并执行请求</span></span><br><span class="line">        CloseableHttpResponse response = wxPayClient.execute(httpPost);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String bodyAsString = EntityUtils.toString(response.getEntity());<span class="comment">//响应体</span></span><br><span class="line">            <span class="keyword">int</span> statusCode = response.getStatusLine().getStatusCode();<span class="comment">//响应状态码</span></span><br><span class="line">            <span class="keyword">if</span> (statusCode == <span class="number">200</span>) &#123; <span class="comment">//处理成功</span></span><br><span class="line">                log.info(<span class="string">"成功, 返回退款结果 = "</span> + bodyAsString);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (statusCode == <span class="number">204</span>) &#123; <span class="comment">//处理成功，无返回Body</span></span><br><span class="line">                log.info(<span class="string">"成功"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"退款异常，响应码 = "</span> + statusCode + <span class="string">"，退款返回结果 = "</span> + bodyAsString);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//更新订单状态</span></span><br><span class="line">            orderInfoService.updateStatusByOrderNo(orderNo, OrderStatus.REFUND_PROCESSING);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//更新退款订单</span></span><br><span class="line">            refundsInfoService.updateRefund(bodyAsString);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            response.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建 updateRefund 业务方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//记录退款记录</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateRefund</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//将json转为Map</span></span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        Map&lt;String, String&gt; resultMap = gson.fromJson(content, HashMap<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据退款单号修改退款单</span></span><br><span class="line">        QueryWrapper&lt;RefundInfo&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(<span class="string">"refund_no"</span>, resultMap.get(<span class="string">"out_refund_no"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置要修改的字段</span></span><br><span class="line">        RefundInfo refundInfo = <span class="keyword">new</span> RefundInfo();</span><br><span class="line">        refundInfo.setRefundId(resultMap.get(<span class="string">"refund_id"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询退款和申请退款返回的参数</span></span><br><span class="line">        <span class="keyword">if</span>(resultMap.get(<span class="string">"status"</span>) != <span class="keyword">null</span>)&#123;</span><br><span class="line">            refundInfo.setRefundStatus(resultMap.get(<span class="string">"status"</span>));    <span class="comment">//退款状态</span></span><br><span class="line">            refundInfo.setContentReturn(content);<span class="comment">//将全部响应结果存入数据库的content字段</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//退款回调中的回调参数</span></span><br><span class="line">        <span class="keyword">if</span>(resultMap.get(<span class="string">"refund_status"</span>) != <span class="keyword">null</span>)&#123;</span><br><span class="line">            refundInfo.setRefundStatus(resultMap.get(<span class="string">"refund_status"</span>)); <span class="comment">//退款状态</span></span><br><span class="line">            refundInfo.setContentNotify(content);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新退款单</span></span><br><span class="line">        baseMapper.update(refundInfo, queryWrapper);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="退款结果通知"><a href="#退款结果通知" class="headerlink" title="退款结果通知"></a>退款结果通知</h2><ul>
<li>于 WxPayController 中添加方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//退款通知</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/refunds/notify"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">refundsNotify</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span>&#123;</span><br><span class="line">        log.info(<span class="string">"退款通知执行"</span>);</span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();   <span class="comment">//应答对象</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//处理通知参数</span></span><br><span class="line">            String body = HttpUtils.readData(request);</span><br><span class="line">            Map&lt;String,Object&gt; bodyMap = gson.fromJson(body, HashMap<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            String requestId = (String)bodyMap.get(<span class="string">"id"</span>);</span><br><span class="line">            log.info(<span class="string">"支付通知的id ===&gt; &#123;&#125;"</span>,bodyMap.get(<span class="string">"id"</span>));</span><br><span class="line">            log.info(<span class="string">"支付通知完整数据 ===&gt; &#123;&#125;"</span>,body);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//签名的验证</span></span><br><span class="line">            WechatPay2ValidatorRequest wechatPay2ValidatorRequest = <span class="keyword">new</span> WechatPay2ValidatorRequest(verifier, requestId, body);</span><br><span class="line">            <span class="keyword">if</span>(!wechatPay2ValidatorRequest.validate(request))&#123;</span><br><span class="line">                log.error(<span class="string">"通知验签失败"</span>);</span><br><span class="line">                <span class="comment">//失败应答</span></span><br><span class="line">                response.setStatus(<span class="number">500</span>);</span><br><span class="line">                map.put(<span class="string">"code"</span>, <span class="string">"ERROR"</span>);</span><br><span class="line">                map.put(<span class="string">"message"</span>,<span class="string">"通知验签失败"</span>);</span><br><span class="line">                <span class="keyword">return</span> gson.toJson(map);</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(<span class="string">"通知验签成功"</span>);</span><br><span class="line">            <span class="comment">//处理退款单</span></span><br><span class="line">            wxPayService.processRefund(bodyMap);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//成功应答</span></span><br><span class="line">            response.setStatus(<span class="number">200</span>);</span><br><span class="line">            map.put(<span class="string">"code"</span>, <span class="string">"SUCCESS"</span>);</span><br><span class="line">            map.put(<span class="string">"message"</span>,<span class="string">"成功"</span>);</span><br><span class="line">            <span class="keyword">return</span> gson.toJson(map);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//失败应答</span></span><br><span class="line">            response.setStatus(<span class="number">500</span>);</span><br><span class="line">            map.put(<span class="string">"code"</span>, <span class="string">"ERROR"</span>);</span><br><span class="line">            map.put(<span class="string">"message"</span>,<span class="string">"失败"</span>);</span><br><span class="line">            <span class="keyword">return</span> gson.toJson(map);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建 processRefund 业务方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//处理退款单</span></span><br><span class="line">    <span class="meta">@Transactional</span>(rollbackFor = Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">Override</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">void</span> <span class="title">processRefund</span>(<span class="title">Map</span>&lt;<span class="title">String</span>, <span class="title">Object</span>&gt; <span class="title">bodyMap</span>) <span class="title">throws</span> <span class="title">GeneralSecurityException</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"退款单"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解密报文</span></span><br><span class="line">        String plainText = decryptFromResource(bodyMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将明文转换为map</span></span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        HashMap plainTextMap = gson.fromJson(plainText, HashMap<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        String orderNo = (String) plainTextMap.get(<span class="string">"out_trade_no"</span>); <span class="comment">//获取订单号</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(lock.tryLock())&#123; <span class="comment">//锁存在</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//处理重复的通知</span></span><br><span class="line">                String orderStatus = orderInfoService.getOrderStatus(orderNo);</span><br><span class="line">                <span class="keyword">if</span>(!OrderStatus.REFUND_PROCESSING.getType().equals(orderStatus))&#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//更新订单状态</span></span><br><span class="line">                orderInfoService.updateStatusByOrderNo(orderNo,OrderStatus.REFUND_SUCCESS);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//记录支付日志</span></span><br><span class="line">                paymentInfoService.createPaymentInfo(plainText);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//释放锁</span></span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="下载账单"><a href="#下载账单" class="headerlink" title="下载账单"></a>下载账单</h2><ul>
<li>于 WxPayService 中创建抽象方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">queryBill</span><span class="params">(String billDate,String type)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建其业务方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询账单</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">queryBill</span><span class="params">(String billDate,String type)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        log.warn(<span class="string">"申请账单接口调用：&#123;&#125;"</span>,billDate);</span><br><span class="line"></span><br><span class="line">        String url = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">"tradebill"</span>.equals(type))&#123;</span><br><span class="line">            url = WxApiType.TRADE_BILLS.getType();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"fundflowbill"</span>.equals(type))&#123;</span><br><span class="line">            url = WxApiType.FUND_FLOW_BILLS.getType();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"不支持的账单类型"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        url = wxPayConfig.getDomain().concat(url).concat(<span class="string">"?bill_date="</span>).concat(billDate);</span><br><span class="line"></span><br><span class="line">        HttpGet httpGet = <span class="keyword">new</span> HttpGet(url);</span><br><span class="line">        httpGet.setHeader(<span class="string">"Accept"</span>,<span class="string">"application/json"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//完成签名并执行请求</span></span><br><span class="line">        CloseableHttpResponse response = wxPayClient.execute(httpGet);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String bodyAsString = EntityUtils.toString(response.getEntity());<span class="comment">//响应体</span></span><br><span class="line">            <span class="keyword">int</span> statusCode = response.getStatusLine().getStatusCode();<span class="comment">//响应状态码</span></span><br><span class="line">            <span class="keyword">if</span> (statusCode == <span class="number">200</span>) &#123; <span class="comment">//处理成功</span></span><br><span class="line">                log.info(<span class="string">"成功, 申请账单返回结果 = "</span> + bodyAsString);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (statusCode == <span class="number">204</span>) &#123; <span class="comment">//处理成功，无返回Body</span></span><br><span class="line">                log.info(<span class="string">"成功"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.info(<span class="string">"账单获取失败,响应码 = "</span> + statusCode+ <span class="string">",返回结果 = "</span> + bodyAsString);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"request failed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//获取账单下载地址</span></span><br><span class="line">            Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">            Map&lt;String,String&gt; resultMap = gson.fromJson(bodyAsString, HashMap<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> resultMap.get(<span class="string">"download_url"</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            response.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>于 WxPayController 添加下载账单接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//下载账单</span></span><br><span class="line"><span class="meta">@ApiOperation</span>(<span class="string">"下载账单"</span>)</span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/downloadbill/&#123;billdate&#125;/&#123;type&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">downlodBill</span><span class="params">(@PathVariable String billDate,@PathVariable String type)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    log.info(<span class="string">"下载账单"</span>);</span><br><span class="line">    String result = wxPayService.downloadBill(billDate,type);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> R.ok().data(<span class="string">"result"</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建 downloadBill 业务方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> CloseableHttpClient wxPayNoSignClient; <span class="comment">//无需应答签名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//下载账单</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">downloadBill</span><span class="params">(String billDate, String type)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        log.warn(<span class="string">"下载账单接口调用：&#123;&#125;, &#123;&#125;"</span>,billDate,type);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取账单url地址</span></span><br><span class="line">        String downloadUrl = <span class="keyword">this</span>.queryBill(billDate, type);</span><br><span class="line">        <span class="comment">//创建远程Get，请求对象</span></span><br><span class="line">        HttpGet httpGet = <span class="keyword">new</span> HttpGet(downloadUrl);</span><br><span class="line">        httpGet.setHeader(<span class="string">"Accept"</span>,<span class="string">"application/json"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//完成签名并执行请求</span></span><br><span class="line">        CloseableHttpResponse response = wxPayNoSignClient.execute(httpGet);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String bodyAsString = EntityUtils.toString(response.getEntity());<span class="comment">//响应体</span></span><br><span class="line">            <span class="keyword">int</span> statusCode = response.getStatusLine().getStatusCode();<span class="comment">//响应状态码</span></span><br><span class="line">            <span class="keyword">if</span> (statusCode == <span class="number">200</span>) &#123; <span class="comment">//处理成功</span></span><br><span class="line">                log.info(<span class="string">"成功, 申请账单返回结果 = "</span> + bodyAsString);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (statusCode == <span class="number">204</span>) &#123; <span class="comment">//处理成功，无返回Body</span></span><br><span class="line">                log.info(<span class="string">"成功"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.info(<span class="string">"账单获取失败,响应码 = "</span> + statusCode+ <span class="string">",返回结果 = "</span> + bodyAsString);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"request failed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//获取账单下载地址</span></span><br><span class="line">            Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">            Map&lt;String,String&gt; resultMap = gson.fromJson(bodyAsString, HashMap<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> resultMap.get(<span class="string">"download_url"</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            response.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<img src='/img/springboot/4/16.png'>

<p>至此所有功能都已实现，用户可以自由发起支付请求并完成支付，也可以取消当前订单或对已支付订单发起退款，并能够成功退款。</p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="true">
                <source type="audio/mpeg" src="/music/MIYAVI - Butterfly.mp3">
            </audio>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
		data-enable='true'
        data-ae='false'
        data-ci=''
        data-cs=''
        data-r=''
        data-o=''
        data-a=''
        data-d='false'
    >查看评论</div>


    </div>
    
        <div class='side'>
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#创建项目"><span class="toc-number">1.</span> <span class="toc-text">创建项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#主要依赖引入"><span class="toc-number">1.1.</span> <span class="toc-text">主要依赖引入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义配置文件"><span class="toc-number">1.2.</span> <span class="toc-text">自定义配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置文件"><span class="toc-number">1.3.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ProductController-商品接口"><span class="toc-number">1.4.</span> <span class="toc-text">ProductController 商品接口</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#R-类对前端进行数据反馈"><span class="toc-number">2.</span> <span class="toc-text">R 类对前端进行数据反馈</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#连接数据库"><span class="toc-number">2.1.</span> <span class="toc-text">连接数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建对应数据库表类"><span class="toc-number">2.2.</span> <span class="toc-text">创建对应数据库表类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#持久层接口"><span class="toc-number">2.3.</span> <span class="toc-text">持久层接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service接口"><span class="toc-number">2.4.</span> <span class="toc-text">Service接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建-MyBatisPlusConfig-类"><span class="toc-number">2.5.</span> <span class="toc-text">创建 MyBatisPlusConfig 类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#前端初步配置"><span class="toc-number">3.</span> <span class="toc-text">前端初步配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#基础支付-API-v3"><span class="toc-number">4.</span> <span class="toc-text">基础支付 API v3</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#引入支付参数"><span class="toc-number">4.1.</span> <span class="toc-text">引入支付参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#加载商户私钥"><span class="toc-number">4.2.</span> <span class="toc-text">加载商户私钥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取验签器和-HttpClient"><span class="toc-number">4.3.</span> <span class="toc-text">获取验签器和 HttpClient</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#微信支付-API-字典"><span class="toc-number">4.4.</span> <span class="toc-text">微信支付 API 字典</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工具类"><span class="toc-number">4.5.</span> <span class="toc-text">工具类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Native-支付"><span class="toc-number">4.6.</span> <span class="toc-text">Native 支付</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#存入数据库"><span class="toc-number">4.7.</span> <span class="toc-text">存入数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取已存在的订单"><span class="toc-number">4.8.</span> <span class="toc-text">获取已存在的订单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#存储二维码"><span class="toc-number">4.9.</span> <span class="toc-text">存储二维码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#显示订单列表"><span class="toc-number">4.10.</span> <span class="toc-text">显示订单列表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内网穿透"><span class="toc-number">4.11.</span> <span class="toc-text">内网穿透</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#接收通知和返回应答"><span class="toc-number">4.12.</span> <span class="toc-text">接收通知和返回应答</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#验签"><span class="toc-number">4.13.</span> <span class="toc-text">验签</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#报文解密"><span class="toc-number">4.14.</span> <span class="toc-text">报文解密</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更新订单状态、记录支付日志"><span class="toc-number">4.15.</span> <span class="toc-text">更新订单状态、记录支付日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#处理重复通知"><span class="toc-number">4.16.</span> <span class="toc-text">处理重复通知</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据锁（并发控制）"><span class="toc-number">4.17.</span> <span class="toc-text">数据锁（并发控制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定时查单"><span class="toc-number">4.18.</span> <span class="toc-text">定时查单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#用户取消订单"><span class="toc-number">4.19.</span> <span class="toc-text">用户取消订单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#微信支付查询订单"><span class="toc-number">4.20.</span> <span class="toc-text">微信支付查询订单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#引入定时任务"><span class="toc-number">4.21.</span> <span class="toc-text">引入定时任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#处理超时订单"><span class="toc-number">4.22.</span> <span class="toc-text">处理超时订单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#申请退款"><span class="toc-number">4.23.</span> <span class="toc-text">申请退款</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#退款结果通知"><span class="toc-number">4.24.</span> <span class="toc-text">退款结果通知</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#下载账单"><span class="toc-number">4.25.</span> <span class="toc-text">下载账单</span></a></li></ol></li></ol>	
        </div>
    
</div>


    </div>
</div>
</body>

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>






</html>
